# HAWA API Apache Reverse Proxy Configuration
# File: /etc/apache2/sites-available/hawa-api.conf

<VirtualHost *:80>
    ServerName api.npcb.in
    ServerAlias 15.207.9.17
    
    # Redirect all HTTP traffic to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</VirtualHost>

<VirtualHost *:443>
    ServerName api.npcb.in
    ServerAlias 15.207.9.17
    
    # SSL Configuration (Let's Encrypt)
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/api.npcb.in/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/api.npcb.in/privkey.pem
    
    # Modern SSL Security Configuration
    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder on
    SSLSessionTickets off
    
    # Security Headers
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://unpkg.com https://fonts.googleapis.com; img-src 'self' data: https:; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https:;"
    
    # Reverse Proxy Configuration
    ProxyPreserveHost On
    ProxyRequests Off
    
    # Forward headers to the backend application
    RequestHeader set X-Forwarded-Proto "https"
    
    # Proxy requests to the Node.js API
    ProxyPass / http://127.0.0.1:5000/
    ProxyPassReverse / http://127.0.0.1:5000/
    
    # WebSocket support (requires mod_proxy_wstunnel)
    ProxyPass /ws/ ws://127.0.0.1:5000/ws/
    ProxyPassReverse /ws/ ws://127.0.0.1:5000/ws/
    
    # Logging
    ErrorLog /opt/bitnami/apache/logs/hawa-api_error.log
    CustomLog /opt/bitnami/apache/logs/hawa-api_access.log combined
</VirtualHost>